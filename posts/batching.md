---
layout: base-layout.njk
---

## Батчинг
HLF работает по схеме предварительного расчера результата исполнения транзакций - сначала транзакция отправляется на ендорсмент где исполняется чейнкод и только потом на ордеринг, где уже занимает свою позицию в создаваемом блоке, и после этого происходит публикация блока и апдейт стейтов на распределенных узлах, содержащих реестр (commitment peer).

![hlf_transaction_flow](/doc/uploads/hlf_transaction_flow.drawio.png)

| <b>Схема прохождения транзакции в HLF</b>|

Такой вариант позволяет параллельно обрабатывать большое количество транзакций, но накладывает определенные ограничения на дальнейшую валидацию сформированных блоков . Если в блоке присутствуют взаимозависимые транзакции, то при апдейте стейта commitment peer получит конфликт валидации, так называемыйй MVCC (Multi-Version Concurrency Control) / Например конфликт может быть в случае если обе транзакции изменяли один и тот же ключ в стейте, происходит коллизия при чтении-записи. Данная тема достаточно обширна, полное описание можно посмотреть TODO найти ссылку.

Атомайз решает данную проблему через пакетную обработку данных (batching).
1. Клиент отправляет транзакцию на исполнение
2. Транзакция проходит первичный ендорсмент в результате чего создается запись в стейте с уникальным ключом и поступившими из транзакции данными. На данном этапе не производится никакой обработки данных и MVCC не возможен. Таким образом формируется преимадж (preimage) транзакций в стейте канала, количество которых может быть сколь угодно большим.
3. Специальный сервис (robot) мониторит наличие необработанных преимаджей, создает и публикует транзакцию батчинга, в которой перечисляет набор уникальных ключей, под которыми записаны преимаджи в стейт. При этом сохраняет их порядок поступления.
4. Ендорсеры обрабатывают батч транзакцию как единое целое, циклически читая преимаджи из стейта и передавая параметры транзакции на обработку, а так же кешируя прочитанные и измененные ключи стейта. Таким образом формируется общий результат, который  не будет иметь коллизий чтения и записи.

![batching_sequence](/doc/uploads/batching_sequence.png)
| <b>Схема прохождения транзакции в Атомайз</b>|
